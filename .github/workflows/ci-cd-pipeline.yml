name: Vehicle App - CI Pipeline (Final Corrected)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # CHECKOUT
    # -----------------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # -----------------------------
    # SYSTEM DEPENDENCIES
    # -----------------------------
    - name: Install system packages
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          python3-pip \
          python3-dev \
          pkg-config \
          clang-tidy \
          cppcheck \
          unzip \
          wget

    # -----------------------------
    # INSTALL protoc 3.19.1 (correct version for Velocitas)
    # -----------------------------
    - name: Install protoc 3.19.1 + gRPC C++ plugin
      run: |
        PROTOC_VERSION=3.19.1

        echo "Installing protoc ${PROTOC_VERSION}"
        wget -q https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip -O protoc.zip
        sudo unzip -o protoc.zip -d /usr/local

        echo "Installing gRPC C++ compiler plugin"
        sudo apt update
        sudo apt install -y protobuf-compiler-grpc

        echo "Verifying versions:"
        protoc --version
        which grpc_cpp_plugin

    # -----------------------------
    # INSTALL CONAN 1.x + PyYAML FIX
    # -----------------------------
    - name: Install Conan 1.x
      run: |
        pip3 install --upgrade pip setuptools wheel
        # PyYAML pinned to avoid Cython build failure on Python 3.12
        pip3 install "PyYAML>=6.0.2"
        pip3 install "conan==1.60.0"

        conan --version
        conan config init
        conan profile new default --detect --force
        conan profile update settings.compiler.libcxx=libstdc++11 default

    # -----------------------------
    # RUN CONAN INSTALL (BEFORE CMAKE)
    # -----------------------------
    - name: Run Conan install
      run: |
        mkdir -p build
        conan install . --install-folder=build --build=missing

    # -----------------------------
    # CONFIGURE CMAKE
    # -----------------------------
    - name: Configure CMake
      run: |
        cmake -S . -B build -G Ninja -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

    # -----------------------------
    # BUILD PROJECT
    # -----------------------------
    - name: Build Vehicle App + SDK
      run: |
        cmake --build build --config Release

    # -----------------------------
    # STATIC ANALYSIS: clang-tidy
    # -----------------------------
    - name: Run clang-tidy
      run: |
        echo "Running clang-tidy..."
        clang-tidy -p build $(find sdk examples -name "*.cpp") || true

    # -----------------------------
    # STATIC ANALYSIS: cppcheck (FIXED)
    # Run AFTER build so headers exist
    # -----------------------------
    - name: Run cppcheck (post-build)
      run: |
        echo "Running cppcheck..."
        cppcheck \
          --enable=all \
          --inconclusive \
          --error-exitcode=1 \
          --project=build/compile_commands.json

    # -----------------------------
    # RUN UNIT TESTS
    # -----------------------------
    - name: Run Unit Tests
      run: |
        ctest --test-dir build --output-on-failure

    # -----------------------------
    # DOCKER BUILD
    # -----------------------------
    - name: Build Docker image
      run: |
        docker build -t vehicle-app:latest .

    # -----------------------------
    # INSTALL TRIVY
    # -----------------------------
    - name: Install Trivy
      run: |
        wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.48.3_Linux-64bit.deb
        sudo dpkg -i trivy_0.48.3_Linux-64bit.deb

    # -----------------------------
    # TRIVY SCAN
    # -----------------------------
    - name: Security Scan with Trivy
      run: |
        trivy image --exit-code 1 vehicle-app:latest
