name: Vehicle App - CI Pipeline (Phase 1)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-scan:
    runs-on: ubuntu-22.04   # pin runner version for consistency

    steps:
      # --------------------------------------------------
      # 1) CHECKOUT
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # 2) SYSTEM DEPENDENCIES
      # --------------------------------------------------
      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            python3-dev \
            python3-pip \
            clang-tidy \
            cppcheck \
            wget \
            unzip \
            protobuf-compiler \
            grpc-compiler

      # --------------------------------------------------
      # 3) PYTHON TOOLING + CONAN 1.x
      # --------------------------------------------------
      - name: Upgrade pip tooling
        run: |
          python3 -m pip install --upgrade pip setuptools wheel

      - name: Install Conan 1.x
        run: |
          python3 -m pip install "conan==1.60.0"
          conan --version
          conan profile new default --detect --force
          conan profile update settings.compiler.libcxx=libstdc++11 default

      # --------------------------------------------------
      # 4) CONAN INSTALL
      # --------------------------------------------------
      - name: Conan install dependencies
        run: |
          mkdir -p build
          conan install . \
            --profile default \
            --install-folder=build \
            --build=missing

      # --------------------------------------------------
      # 5) CMAKE CONFIGURE
      # --------------------------------------------------
      - name: Configure CMake
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      # --------------------------------------------------
      # 6) STATIC ANALYSIS: CPPCHECK
      # --------------------------------------------------
      - name: Run cppcheck
        run: |
          cppcheck --enable=all --inconclusive --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            sdk examples

      # --------------------------------------------------
      # 7) STATIC ANALYSIS: CLANG-TIDY
      # --------------------------------------------------
      - name: Run clang-tidy
        run: |
          clang-tidy -p build $(find sdk examples -name '*.cpp')

      # --------------------------------------------------
      # 8) ENSURE gRPC OUTPUT DIR EXISTS
      # --------------------------------------------------
      - name: Create gRPC gens folder
        run: mkdir -p build/gens

      # --------------------------------------------------
      # 9) BUILD (Ninja)
      # --------------------------------------------------
      - name: Build project
        run: |
          cmake --build build --config Release

      # --------------------------------------------------
      # 10) UNIT TESTS (ctest in build dir)
      # --------------------------------------------------
      - name: Run unit tests
        run: |
          ctest --test-dir build --output-on-failure

      # --------------------------------------------------
      # 11) DOCKER BUILD
      # --------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t vehicle-app:latest .

      # --------------------------------------------------
      # 12) TRIVY IMAGE SCAN
      # --------------------------------------------------
      - name: Security scan with Trivy
        uses: aquasecurity/trivy-action@v0.20.0
        with:
          image-ref: 'vehicle-app:latest'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '1'
