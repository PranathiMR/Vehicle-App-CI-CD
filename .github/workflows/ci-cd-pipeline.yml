name: Vehicle App - CI Pipeline (FINAL FIXED)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # CHECKOUT
    # -----------------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # -----------------------------
    # INSTALL SYSTEM DEPENDENCIES
    # -----------------------------
    - name: Install system packages
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          pkg-config \
          python3-pip \
          clang-tidy \
          cppcheck \
          wget \
          unzip

    # -----------------------------
    # INSTALL PROTOBUF + gRPC COMPILER (CORRECT)
    # -----------------------------
    - name: Install Protobuf + gRPC C++ plugin
      run: |
        sudo apt update
        sudo apt install -y \
          protobuf-compiler \
          protobuf-compiler-grpc \
          libgrpc++-dev \
          libprotobuf-dev

        echo "=== Versions ==="
        protoc --version
        which grpc_cpp_plugin


    # -----------------------------
    # INSTALL CONAN 1.x (FIXED PyYAML)
    # -----------------------------
    - name: Install Conan 1.x
      run: |
        pip install --upgrade pip
        pip install PyYAML==6.0.1 --only-binary=:all:
        pip install "conan==1.60.0"
        conan config init
        conan profile new default --detect --force
        conan profile update settings.compiler.libcxx=libstdc++11 default


    # -----------------------------
    # CONAN INSTALL
    # -----------------------------
    - name: Run Conan Install
      run: |
        mkdir -p build
        conan install . --install-folder=build --build=missing

    # -----------------------------
    # CMAKE CONFIGURE & BUILD
    # -----------------------------
    - name: Configure + Build Project
      run: |
        cmake -S . -B build -G Ninja -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        cmake --build build --config Release

    # -----------------------------
    # STATIC ANALYSIS: CLANG-TIDY
    # -----------------------------
    - name: Run clang-tidy
      run: |
        echo "=== Running clang-tidy ==="
        clang-tidy -p build $(find sdk examples -name "*.cpp") || true

    # -----------------------------
    # STATIC ANALYSIS: CPPCHECK (AFTER BUILD)
    # -----------------------------
    - name: Run cppcheck
      run: |
        echo "=== Running cppcheck after build ==="
        cppcheck \
          --enable=all \
          --inconclusive \
          --error-exitcode=1 \
          --project=build/compile_commands.json

    # -----------------------------
    # RUN UNIT TESTS
    # -----------------------------
    - name: Run Unit Tests
      run: |
        ctest --test-dir build --output-on-failure

    # -----------------------------
    # DOCKER BUILD
    # -----------------------------
    - name: Build Docker image
      run: |
        docker build -t vehicle-app:latest .

    # -----------------------------
    # INSTALL TRIVY
    # -----------------------------
    - name: Install Trivy
      run: |
        wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.48.3_Linux-64bit.deb
        sudo dpkg -i trivy_0.48.3_Linux-64bit.deb

    # -----------------------------
    # TRIVY DOCKER SCAN
    # -----------------------------
    - name: Scan Docker image with Trivy
      run: |
        trivy image --exit-code 1 vehicle-app:latest
