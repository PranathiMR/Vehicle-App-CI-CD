name: Vehicle App - CI Pipeline (FINAL FIXED)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # CHECKOUT
    # -----------------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # -----------------------------
    # INSTALL SYSTEM DEPENDENCIES
    # -----------------------------
    - name: Install system packages
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          pkg-config \
          python3-pip \
          clang-tidy \
          cppcheck \
          wget \
          unzip

    # -----------------------------
    # INSTALL PROTOBUF + gRPC COMPILER (FIXED)
    # -----------------------------
    - name: Build and Install gRPC C++ from source
      run: |
        git clone --recurse-submodules -b v1.50.1 https://github.com/grpc/grpc
        cd grpc
        mkdir -p cmake/build
        cd cmake/build
        cmake ../.. -DgRPC_BUILD_TESTS=OFF
        make -j4
        sudo make install

        which grpc_cpp_plugin
        grpc_cpp_plugin --version || true


    # -----------------------------
    # INSTALL CONAN (FIXED â€” NO PYTHON BUILD ERRORS)
    # -----------------------------
    # -----------------------------
# INSTALL CONAN 1.x (WORKING FIX)
# -----------------------------
    - name: Install Conan (APT official repo)
      run: |
        sudo apt update
        sudo apt install -y apt-transport-https ca-certificates gnupg software-properties-common

        # Add official Conan APT repo key
        sudo mkdir -p /etc/apt/keyrings
        curl -fsSL https://downloads.conan.io/keys/conan.gpg \
          | sudo gpg --dearmor -o /etc/apt/keyrings/conan.gpg

        # Add official Conan repo source
        echo "deb [signed-by=/etc/apt/keyrings/conan.gpg] https://downloads.conan.io/apt stable main" \
          | sudo tee /etc/apt/sources.list.d/conan.list

        sudo apt update
        sudo apt install -y conan

        # Initialize Conan profile
        conan profile new default --detect --force
        conan profile update settings.compiler.libcxx=libstdc++11 default

        conan --version

# -----------------------------
# CONAN INSTALL
# -----------------------------
    - name: Run Conan Install
      run: |
        mkdir -p build
        conan install . --install-folder=build --build=missing

    # -----------------------------
    # CMAKE CONFIGURE & BUILD
    # -----------------------------
    - name: Configure + Build Project
      run: |
        cmake -S . -B build -G Ninja -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        cmake --build build --config Release

    # -----------------------------
    # STATIC ANALYSIS: CLANG-TIDY
    # -----------------------------
    - name: Run clang-tidy
      run: |
        echo "=== Running clang-tidy ==="
        clang-tidy -p build $(find sdk examples -name "*.cpp") || true

    # -----------------------------
    # STATIC ANALYSIS: CPPCHECK (AFTER BUILD)
    # -----------------------------
    - name: Run cppcheck
      run: |
        echo "=== Running cppcheck after build ==="
        cppcheck \
          --enable=all \
          --inconclusive \
          --error-exitcode=1 \
          --project=build/compile_commands.json

    # -----------------------------
    # RUN UNIT TESTS
    # -----------------------------
    - name: Run Unit Tests
      run: |
        ctest --test-dir build --output-on-failure

    # -----------------------------
    # DOCKER BUILD
    # -----------------------------
    - name: Build Docker image
      run: |
        docker build -t vehicle-app:latest .

    # -----------------------------
    # INSTALL TRIVY
    # -----------------------------
    - name: Install Trivy
      run: |
        wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.48.3_Linux-64bit.deb
        sudo dpkg -i trivy_0.48.3_Linux-64bit.deb

    # -----------------------------
    # TRIVY DOCKER SCAN
    # -----------------------------
    - name: Scan Docker image with Trivy
      run: |
        trivy image --exit-code 1 vehicle-app:latest
