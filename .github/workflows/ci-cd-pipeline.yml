name: Vehicle App - CI Pipeline (Phase 1)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # CHECKOUT CODE
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # -----------------------------
      # INSTALL SYSTEM DEPENDENCIES
      # -----------------------------
      - name: Install system packages
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            python3-pip \
            clang-tidy \
            wget \
            unzip

      # -----------------------------
      # INSTALL protoc + gRPC C++ plugin
      # -----------------------------
      - name: Install protoc + gRPC C++ plugin
        run: |
          PROTOC_VERSION=3.19.1

          echo "=== INSTALLING PROTOC ==="
          wget -q https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip -O protoc.zip
          sudo unzip -o protoc.zip -d /usr/local

          sudo apt-get update
          sudo apt-get install -y grpc-proto

          which protoc
          protoc --version
          which grpc_cpp_plugin || echo "grpc_cpp_plugin provided inside protoc package"

      # -----------------------------
      # INSTALL CONAN (PyYAML FIX)
      # -----------------------------
      - name: Install Conan 1.x
        run: |
          pip3 install --upgrade pip
          pip3 install "PyYAML==5.4.1"
          pip3 install "conan==1.60.0"

          conan config init
          conan profile new default --detect --force
          conan profile update settings.compiler.libcxx=libstdc++11 default

      # -----------------------------
      # CONAN INSTALL
      # -----------------------------
      - name: Conan install
        run: |
          mkdir -p build
          conan install . --install-folder=build --build=missing

      # -----------------------------
      # CONFIGURE CMAKE
      # -----------------------------
      - name: CMake configure
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      # -----------------------------
      # CLANG-TIDY (RESTORED HERE)
      # -----------------------------
      - name: Run clang-tidy
        run: |
          echo ">>> Running clang-tidy"
          find sdk examples -name "*.cpp" | xargs clang-tidy -p build

      # -----------------------------
      # BUILD PROJECT
      # -----------------------------
      - name: Build SDK + Apps
        run: |
          cmake --build build --config Release

      # -----------------------------
      # CPPCHECK (MUST RUN AFTER BUILD!)
      # -----------------------------
      - name: Run cppcheck
        run: |
          echo ">>> Running cppcheck AFTER protoc-generated files exist"
          cppcheck --enable=all --inconclusive --error-exitcode=1 \
            --project=build/compile_commands.json \
            --suppress=missingIncludeSystem

      # -----------------------------
      # RUN UNIT TESTS
      # -----------------------------
      - name: Run Unit Tests
        run: |
          ctest --test-dir build --output-on-failure

      # -----------------------------
      # DOCKER BUILD
      # -----------------------------
      - name: Build Docker Image
        run: |
          docker build -t vehicle-app:latest .

      # -----------------------------
      # INSTALL TRIVY
      # -----------------------------
      - name: Install Trivy
        run: |
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.48.3_Linux-64bit.deb
          sudo dpkg -i trivy_0.48.3_Linux-64bit.deb

      # -----------------------------
      # TRIVY SCAN
      # -----------------------------
      - name: Security Scan with Trivy
        run: |
          trivy image --exit-code 1 vehicle-app:latest
