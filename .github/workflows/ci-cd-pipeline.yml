name: Vehicle App - CI Pipeline (Phase 1)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-scan:
    runs-on: ubuntu-22.04   # Use stable LTS runner

    steps:
      # -----------------------------
      # CHECKOUT CODE
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # -----------------------------
      # INSTALL SYSTEM DEPENDENCIES
      # -----------------------------
      - name: Install system packages
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            python3-pip \
            clang-tidy \
            cppcheck \
            protobuf-compiler \
            grpc-compiler \
            wget \
            unzip

      # -----------------------------
      # INSTALL CONAN 1.x + FIX PyYAML
      # -----------------------------
      - name: Install Conan 1.x
        run: |
          python3 -m pip install --upgrade pip wheel
          python3 -m pip install "PyYAML==6.0.2" "conan==1.60.0"

          # Configure Conan
          conan config init
          conan profile new default --detect --force
          conan profile update settings.compiler.libcxx=libstdc++11 default
          conan --version

      # -----------------------------
      # CONAN INSTALL
      # -----------------------------
      - name: Run Conan Install
        run: |
          mkdir -p build
          conan install . --install-folder=build --build=missing

      # -----------------------------
      # CONFIGURE CMAKE
      # -----------------------------
      - name: CMake configure
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      # -----------------------------
      # BUILD PROJECT
      # -----------------------------
      - name: Build project
        run: |
          cmake --build build --config Release

      # -----------------------------
      # STATIC ANALYSIS: CPPCHECK
      # -----------------------------
      # Must run AFTER build so compile_commands.json is present
      # Fixes missing include-path errors
      - name: Run cppcheck
        run: |
          cppcheck \
            --project=build/compile_commands.json \
            --enable=all \
            --inconclusive \
            --error-exitcode=1

      # -----------------------------
      # STATIC ANALYSIS: CLANG-TIDY
      # -----------------------------
      - name: Run clang-tidy
        run: |
          clang-tidy -p build $(find sdk examples -name "*.cpp")

      # -----------------------------
      # RUN UNIT TESTS
      # -----------------------------
      - name: Run Unit Tests
        run: |
          ctest --test-dir build --output-on-failure

      # -----------------------------
      # DOCKER BUILD
      # -----------------------------
      - name: Build Docker Image
        run: |
          docker build -t vehicle-app:latest .

      # -----------------------------
      # INSTALL TRIVY (STABLE VERSION)
      # -----------------------------
      - name: Install Trivy
        run: |
          wget https://github.com/aquasecurity/trivy/releases/download/v0.45.0/trivy_0.45.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.45.0_Linux-64bit.deb

      # -----------------------------
      # TRIVY SCAN
      # -----------------------------
      - name: Security Scan with Trivy
        run: |
          trivy image --exit-code 1 vehicle-app:latest
