name: Vehicle App - CI Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # -----------------------------
      # CHECKOUT
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # INSTALL SYSTEM DEPENDENCIES
      # -----------------------------
      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            python3-pip \
            python3-setuptools \
            python3-wheel \
            clang-tidy \
            cppcheck \
            wget \
            unzip

      # -----------------------------
      # INSTALL PROTOBUF & gRPC C++ COMPILER
      # (WORKING VERSIONED LINKS)
      # -----------------------------
      - name: Install protoc + gRPC C++ plugin
        run: |
          PROTOC_VERSION=3.19.6

          echo "=== INSTALLING PROTOC ==="
          wget -q https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip -O protoc.zip
          sudo unzip -o protoc.zip -d /usr/local

          echo "=== INSTALLING gRPC C++ plugin ==="
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler-grpc

          echo "=== VERIFY INSTALL ==="
          protoc --version
          which protoc
          which grpc_cpp_plugin


      # -----------------------------
      # INSTALL CONAN (PINNED, NO PyYAML FAILURE)
      # -----------------------------
      - name: Install Conan 1.x
        run: |
          pip3 install "PyYAML==5.4.1"
          pip3 install "conan==1.60.0"
          conan config init
          conan profile new default --detect --force
          conan profile update settings.compiler.libcxx=libstdc++11 default

      # -----------------------------
      # CONAN INSTALL
      # -----------------------------
      - name: Conan Install
        run: |
          mkdir -p build
          conan install . --install-folder=build --build=missing

      # -----------------------------
      # STATIC ANALYSIS
      # -----------------------------
      - name: Run cppcheck
        run: cppcheck --error-exitcode=1 --enable=all --inconclusive sdk examples

      - name: Run clang-tidy
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          clang-tidy -p build $(find sdk examples -name "*.cpp")

      # -----------------------------
      # BUILD PROJECT
      # -----------------------------
      - name: Build SDK + Apps
        run: |
          cmake --build build --config Release

      # -----------------------------
      # UNIT TESTS
      # -----------------------------
      - name: Run unit tests
        run: |
          ctest --test-dir build --output-on-failure

      # -----------------------------
      # DOCKER BUILD
      # -----------------------------
      - name: Build Docker image
        run: docker build -t vehicle-app:latest .

      # -----------------------------
      # TRIVY SCAN (FIXED ACTION VERSION)
      # -----------------------------
      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@0.19.0
        with:
          image-ref: "vehicle-app:latest"
          format: "table"
          exit-code: "1"  # Fail pipeline on vulnerabilities
          severity: "CRITICAL,HIGH"
