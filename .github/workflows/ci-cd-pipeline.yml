name: Vehicle App - CI Pipeline (Phase 1)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # -----------------------------
      # SYSTEM DEPENDENCIES
      # -----------------------------
      - name: Install system packages
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            python3-pip \
            clang-tidy \
            cppcheck \
            wget \
            unzip

      # -----------------------------
      # INSTALL PROTOC 3.19.1
      # -----------------------------
      - name: Install protoc 3.19.1
        run: |
          PROTOC_VERSION=3.19.1
          wget -q https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip -O protoc.zip
          sudo unzip -o protoc.zip -d /usr/local
          protoc --version

      # -----------------------------
      # INSTALL CONAN 1.x
      # -----------------------------
      - name: Install Conan
        run: |
          pip3 install --upgrade pip
          pip3 install "conan==1.60.0"
          conan profile new default --detect --force
          conan profile update settings.compiler.libcxx=libstdc++11 default

      # OPTIONAL: Add Velocitas remotes if needed
      - name: Add Conan remote
        run: conan remote add velocitas https://packages.automotive.microfocus.com/artifactory/api/conan/conan-velocitas --force || true

      # -----------------------------
      # CONAN INSTALL
      # -----------------------------
      - name: Run Conan Install
        run: |
          mkdir -p build
          conan install . -if build -b missing

      # -----------------------------
      # USE grpc_cpp_plugin FROM CONAN
      # -----------------------------
      - name: Configure grpc_cpp_plugin
        run: |
          plugin=$(find ~/.conan/data/grpc/*/*/*/package/*/bin/grpc_cpp_plugin | head -n 1)
          sudo ln -sf "$plugin" /usr/local/bin/grpc_cpp_plugin
          grpc_cpp_plugin --version || true

      # -----------------------------
      # STATIC ANALYSIS
      # -----------------------------
      - name: Run cppcheck
        run: cppcheck --enable=all --inconclusive --error-exitcode=1 sdk examples

      - name: Run clang-tidy
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          clang-tidy -p build $(find sdk examples -name "*.cpp")

      # -----------------------------
      # PREPARE gRPC OUTPUT DIR
      # -----------------------------
      - name: Create gRPC generation folder
        run: mkdir -p build/gens

      # -----------------------------
      # BUILD PROJECT
      # -----------------------------
      - name: Build SDK + Apps
        run: |
          cmake -S . -B build -G Ninja \
            -D_gRPC_PROTOBUF_PROTOC_EXECUTABLE=/usr/local/bin/protoc \
            -D_gRPC_CPP_PLUGIN_EXECUTABLE=/usr/local/bin/grpc_cpp_plugin
          
          cmake --build build --config Release

      # -----------------------------
      # RUN UNIT TESTS
      # -----------------------------
      - name: Run Unit Tests
        run: ctest --test-dir build --output-on-failure

      # -----------------------------
      # DOCKER BUILD
      # -----------------------------
      - name: Build Docker Image
        run: docker build -t vehicle-app:latest .

      # -----------------------------
      # INSTALL TRIVY
      # -----------------------------
      - name: Install Trivy
        run: |
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.48.3_Linux-64bit.deb
          sudo dpkg -i trivy_0.48.3_Linux-64bit.deb

      # -----------------------------
      # TRIVY SCAN
      # -----------------------------
      - name: Security Scan with Trivy
        run: trivy image --exit-code 1 vehicle-app:latest
