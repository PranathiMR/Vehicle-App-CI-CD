name: Vehicle App - CI Pipeline (FINAL FIXED)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # CHECKOUT
    # -----------------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # -----------------------------
    # INSTALL SYSTEM DEPENDENCIES
    # -----------------------------
    - name: Install system packages
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          pkg-config \
          python3-pip \
          clang-tidy \
          cppcheck \
          wget \
          unzip

    # -----------------------------
    # INSTALL PROTOBUF + gRPC COMPILER (FIXED)
    # -----------------------------
    - name: Install Protobuf 3.19 + gRPC C++ plugin
      run: |
        sudo apt update

        # Remove any previous protoc/protobuf to avoid version conflicts
        sudo apt remove -y protobuf-compiler libprotobuf-dev || true

        # Install protoc 3.19.x manually (Ubuntu apt no longer provides it)
        PROTOC_VERSION=3.19.6
        wget https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip
        sudo unzip protoc-${PROTOC_VERSION}-linux-x86_64.zip -d /usr/local
        rm protoc-${PROTOC_VERSION}-linux-x86_64.zip

        # Install gRPC C++ plugin (matching Conan’s typical 1.48–1.50 versions)
        python3 -m pip install --upgrade pip
        python3 -m pip install "grpcio==1.48.0" --only-binary=:all:

        echo "=== Versions ==="
        protoc --version
        which grpc_cpp_plugin || echo "grpc_cpp_plugin missing"



    # -----------------------------
    # INSTALL CONAN (FIXED — NO PYTHON BUILD ERRORS)
    # -----------------------------
    - name: Install Conan
      run: |
        pipx install conan==1.60.0
        pipx ensurepath
        conan --version
        conan profile new default --detect --force
        conan profile update settings.compiler.libcxx=libstdc++11 default

    # -----------------------------
    # CONAN INSTALL
    # -----------------------------
    - name: Run Conan Install
      run: |
        mkdir -p build
        conan install . --install-folder=build --build=missing

    # -----------------------------
    # CMAKE CONFIGURE & BUILD
    # -----------------------------
    - name: Configure + Build Project
      run: |
        cmake -S . -B build -G Ninja -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        cmake --build build --config Release

    # -----------------------------
    # STATIC ANALYSIS: CLANG-TIDY
    # -----------------------------
    - name: Run clang-tidy
      run: |
        echo "=== Running clang-tidy ==="
        clang-tidy -p build $(find sdk examples -name "*.cpp") || true

    # -----------------------------
    # STATIC ANALYSIS: CPPCHECK (AFTER BUILD)
    # -----------------------------
    - name: Run cppcheck
      run: |
        echo "=== Running cppcheck after build ==="
        cppcheck \
          --enable=all \
          --inconclusive \
          --error-exitcode=1 \
          --project=build/compile_commands.json

    # -----------------------------
    # RUN UNIT TESTS
    # -----------------------------
    - name: Run Unit Tests
      run: |
        ctest --test-dir build --output-on-failure

    # -----------------------------
    # DOCKER BUILD
    # -----------------------------
    - name: Build Docker image
      run: |
        docker build -t vehicle-app:latest .

    # -----------------------------
    # INSTALL TRIVY
    # -----------------------------
    - name: Install Trivy
      run: |
        wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.48.3_Linux-64bit.deb
        sudo dpkg -i trivy_0.48.3_Linux-64bit.deb

    # -----------------------------
    # TRIVY DOCKER SCAN
    # -----------------------------
    - name: Scan Docker image with Trivy
      run: |
        trivy image --exit-code 1 vehicle-app:latest
